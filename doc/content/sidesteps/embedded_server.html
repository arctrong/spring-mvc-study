<!DOCTYPE html>
<html>
<head><title>Embedded server</title>
<meta charset="utf-8">
<link rel="shortcut icon" type="image/png" href="../../favicon.png"/>
<link rel="stylesheet" type="text/css" href="../../layout/styles.css"/>
<link rel="stylesheet" type="text/css" href="../../layout/layout.css"/>

<link rel="stylesheet" type="text/css" href="../../theme.css"/>
<style>
.headerNavArrows {position: relative; top: 3px;}
</style>
</head>
<body>

<div class="header"><b><span style="color:greenyellow;margin-right:7px;">Spring Web<span class="localOnly" title="Unrestricted">*</span></span></b><a 
class="header_item" href="../../../readme.html">About</a><a 
class="header_item" href="../index_page.html">Index</a><a 
class="header_item" href="https://github.com/arctrong/spring-mvc-study">GitHub</a>

<a href="../../../doc_src/content/sidesteps/embedded_server.txt " class="header_item_source" title="Source text">&lt;/&gt;</a>


<a href="jetty_server_notes.html" title="Previous: Jetty server notes"><img class="headerNavArrows" src="../../layout/pict/previous_page_h18px.png"/></a>


<img class="headerNavArrows" src="../../layout/pict/next_page_h18px_inactive.png"/>

<span class="headerTitle">Embedded server</span>

</div>

<div class="sidebar">
    <table class="sidebarAligner">
        <tr><td valign="top">
            
            <a href="../../../readme.html" class="sidebar_item">About the course</a>
<a href="../references.html" class="sidebar_item">References</a>
<a href="../common_notes.html" class="sidebar_item">Common notes</a>
            <h3>Beginner</h3>
            <a href="../beginner/about_part_1.html" class="sidebar_item">About this part</a>
<a href="../beginner/server_setup.html" class="sidebar_item">Server setup</a>
<a href="../beginner/front_controller.html" class="sidebar_item">Front controller</a>
<a href="../beginner/spring_web_app_setup.html" class="sidebar_item">Spring web application setup</a>
<a href="../beginner/web_application_context.html" class="sidebar_item">Web application context</a>
<a href="../beginner/view_resolver.html" class="sidebar_item">View resolver</a>
<a href="../beginner/model.html" class="sidebar_item">Model</a>
            <h3>Intermediate</h3>
            <a href="../intermediate/about_part_2.html" class="sidebar_item">About this part</a>
<a href="../intermediate/get_rid_of_web_xml.html" class="sidebar_item">Get rid of XML configuration</a>
<a href="../intermediate/data_binding.html" class="sidebar_item">Data binding</a>
<a href="../intermediate/registration_form.html" class="sidebar_item">Registration form</a>
<a href="../intermediate/form_validation.html" class="sidebar_item">Form validation</a>
<a href="../intermediate/formatters.html" class="sidebar_item">Spring MVC Formatter</a>
<a href="../intermediate/send_email.html" class="sidebar_item">Send email</a>
<a href="../intermediate/sessions_and_cookies.html" class="sidebar_item">Sessions and cookies</a>
<a href="../intermediate/service_layer.html" class="sidebar_item">Service layer</a>
<a href="../intermediate/exception_handling.html" class="sidebar_item">Exception handling</a>
            <h3>Sidesteps</h3>
            <a href="sidesteps.html" class="sidebar_item">Sidesteps</a>
<a href="jetty_server_notes.html" class="sidebar_item">Jetty server notes</a>
<a href="embedded_server.html" class="sidebar_item selected">Embedded server</a>
        </td></tr>
        <tr><td class="bottom" valign="bottom">
            Generated by <a href="https://github.com/arctrong/md2html">md2html_py</a> 1.0.3
        </td></tr>
    </table>
</div>

<p style="font-size:44px;font-weight:bold;margin:0 0 30px 0;">Embedded server</p>

<div class="toc">
<ul>
<li><a href="#about-this-section">About this section</a></li>
<li><a href="#jetty-live-war-with-jsp">Jetty live WAR with JSP</a><ul>
<li><a href="#creating-standard-war-application">Creating standard WAR application</a></li>
<li><a href="#converting-into-multi-module-maven-project">Converting into multi module Maven project</a></li>
<li><a href="#adding-live-war-elements">Adding live WAR elements</a></li>
<li><a href="#discussions-and-explanations">Discussions and explanations</a></li>
</ul>
</li>
<li><a href="#warless-jar-with-jsp-incomplete">WARless JAR with JSP (incomplete)</a></li>
</ul>
</div>
<hr />
<p>May 7, 2023</p>
<h1 id="about-this-section">About this section</h1>
<p>This section is intended for discussion on different ways of embedded server setup with Spring MVC.</p>
<p>The topic doesn't look to be simple and straightforward. There are quite many materials on the 
Internet but they all probably cover the simplest use cases and contain very little or no 
descriptions and explanations. Some of the materials are listed in [<a href="../references.html#ref_23">23</a>] and [<a href="../references.html#ref_20">20</a>].</p>
<p>Here some certain setups are going to be implemented and explored.</p>
<hr />
<p><a name="index_entry_index_1"></a></p>
<h1 id="jetty-live-war-with-jsp">Jetty live WAR with JSP</h1>
<p>This implementation is made based on the material [<a href="../references.html#ref_20_1">20.1</a>]. The project is declared as being for
investigation purpose. It uses custom class loader, <code>maven-dependency-plugin</code> and probably some
other solutions that make it unstable and add problems when using in production.</p>
<p>The following features were added:</p>
<ul>
<li>Spring MVC support;</li>
<li>JSP support;</li>
<li>necessary resource access restrictions.</li>
</ul>
<p>Also see the StackOverflow question "<a href="https://stackoverflow.com/questions/65637135/how-to-enable-jsp-in-a-jetty-server-in-a-jar-file">How to enable JSP in a Jetty server in a JAR file?</a>", 
<a href="https://stackoverflow.com/a/65637665/3868454">this answer</a>.</p>
<p>The project may be built and run:</p>
<ul>
<li>as a WAR file in a separate Servlet container;</li>
<li>as an executable JAR file (with no Servlet container required);</li>
<li>by running the executable main class inside IntelliJ IDEA IDE.</li>
</ul>
<p>Build directory is changed in the projects to move the generated artifacts out of the study notes
directory:</p>
<pre class="highlight"><code class="language-xml">    ...
    &lt;build&gt;
        &lt;directory&gt;${TMP_MAVEN_BUILDS_DIR}${project.parent.artifactId}/${project.artifactId}&lt;/directory&gt;
    ...</code></pre>
<h2 id="creating-standard-war-application">Creating standard WAR application</h2>
<p><a href="../beginner/server_setup.html">This instructions</a> were used.</p>
<blockquote>
<p>Git commit: <a href="../patches/234605b0cbf55d1dc956b1ee06843bb72abeb7ea.html"><code>234605b0cbf55d1dc956b1ee06843bb72abeb7ea</code></a>
embedded jetty: life war - before embedding</p>
</blockquote>
<p>Further modifications and improvements are going to be done in the next subsections.</p>
<p>Just execute <code>mvn clean package</code> to build the project. Also see 
<a href="../beginner/server_setup.html#project_start_on_server">here</a> for instructions on deployment and
running.</p>
<h2 id="converting-into-multi-module-maven-project">Converting into multi module Maven project</h2>
<p>Just multi module structure created. Live WAR elements will be added later.</p>
<blockquote>
<p>Git commit: <a href="../patches/65666bbcaa8ee2a849ae57eba44dea629a3f7eb3.html"><code>65666bbcaa8ee2a849ae57eba44dea629a3f7eb3</code></a>
web application converted into a module</p>
</blockquote>
<p>Executing <code>mvn clean package</code> for the parent project will generate the WAR file <code>my-webapp.war</code>
the same way as in the previous version.</p>
<h2 id="adding-live-war-elements">Adding live WAR elements</h2>
<blockquote>
<p>Git commit: <a href="../patches/6050a18e8235df32b09f73b75b5b76160434db0c.html"><code>6050a18e8235df32b09f73b75b5b76160434db0c</code></a>
live WAR implemented</p>
<p>Git commit: <a href="../patches/c12f1479711095c55db1d715ed7177c86445a333.html"><code>c12f1479711095c55db1d715ed7177c86445a333</code></a>
life WAR small change</p>
</blockquote>
<p>The following are the Maven modules described:</p>
<ul>
<li><code>my-webapp</code> &mdash; the standard web application that is packaged as a WAR file.</li>
<li><code>jetty_server</code> &mdash; the Jetty server that runs the above web application. It's also used for
    for running the web application from inside an IDE (only IntelliJ IDEA was tested).</li>
<li><code>server_bootstrap</code> &mdash; the module that starts the server from inside the live WAR file.</li>
<li><code>livewar_assembly</code> &mdash; the module that uses the other modules and generates the final 
    live WAR file.</li>
</ul>
<p>The build is done by executing <code>mvn clean package</code> for the parent project.</p>
<p>The generated artifact is the file <code>my-webapp-livewar.war</code>.</p>
<p>Also see <a href="../beginner/server_setup.html#project_start_on_server">here</a> for instructions on deployment
and running.</p>
<p>Running as a JAR file is done the following way:</p>
<pre class="highlight"><code class="language-shell">&gt;java -jar livewar_assembly\my-webapp-livewar.war
...
2023-05-10 13:41:51.825:INFO:oejs.Server:main: Started @4803ms</code></pre>
<p>In IntelliJ IDEA the class <code>jettylivewar.starter.ServerMain</code> from the project <code>jetty_server</code>
may be used for running and debugging the project.</p>
<p>Remote debugging may be done using the instructions
<a href="sidesteps.html#remote_server_debugging">here</a>. Some additional output is added when 
the option <code>-Ddebug=true</code> is used.</p>
<p>The main page is accessible at <a href="http://localhost:8080/">http://localhost:8080/</a>:</p>
<p><img alt="" src="../../pict/live_war_main_page.png" /></p>
<h2 id="discussions-and-explanations">Discussions and explanations</h2>
<p><strong>Adding Spring MVC</strong></p>
<p>In the <code>my-webapp</code> module Spring MVC is added by adding the configuration classes 
<code>MyApplicationInitializer</code> and <code>MyApplicationConfig</code> and the controller class <code>HelloController</code>.
There are some detailed explanations <a href="../intermediate/get_rid_of_web_xml.html">here</a>. When run in a servlet
container this configuration is found automatically.</p>
<p>In the <code>jetty_server</code> module the following class list adjustment is used in the class
<a href="../../../projects/jetty-embedded-live-war/jetty_server/src/main/java/jettylivewar/starter/ServerMain.java"><code>ServerMain</code></a>:</p>
<p><a name="adjusting_configuration_class_list"></a>
<pre class="highlight"><code class="language-code">        ...
        Configuration.ClassList classlist = Configuration.ClassList
                .setServerDefault(server);
        classlist.addBefore(
                "org.eclipse.jetty.webapp.JettyWebXmlConfiguration",
                "org.eclipse.jetty.annotations.AnnotationConfiguration");
        ...</code></pre></p>
<p><a name="index_entry_index_2"></a>
<strong>Adding JSP support</strong></p>
<p><a href="https://www.eclipse.org/jetty/documentation/jetty-9/index.html#configuring-jsp"></a></p>
<p>When the WAR file is run in the Jetty servlet container, JSP support is done externally by the
Jetty's <code>jsp</code> module (also see <a href="../beginner/server_setup.html#activate_jetty_jsp_module">here</a>).
No other actions required inside the standard WAR file.</p>
<p>In the live WAR artifact when running standalone, the 
<a href="embedded_server.html#adjusting_configuration_class_list">above adjustments</a> are required.
Also there's a special procedure <code>enableEmbeddedJspSupport()</code> in the helper class 
<a href="../../../projects/jetty-embedded-live-war/jetty_server/src/main/java/jettylivewar/starter/JspSupportEnablingHelper.java"><code>JspSupportEnablingHelper</code></a>
that is called from the <code>ServerMain</code> class and fulfills all the adjustments.</p>
<p><strong>Security adjustments</strong></p>
<p>The demonstrated adjustments just cover the obvious breach caused by the dual nature of the
generated WAR file that also works as an executable JAR. The server bootstrap classes in the
directory <code>jettylivewar</code> are by default accessible to the web clients. The solution was made
to forbid this directory using <code>&lt;security-constraint&gt;</code> tag in the file <a href="../../../projects/jetty-embedded-live-war/my-webapp/src/main/webapp/WEB-INF/web.xml"><code>web.xml</code></a>.</p>
<pre class="highlight"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
         http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1"&gt;

    &lt;context-param&gt;
        &lt;param-name&gt;org.eclipse.jetty.servlet.Default.dirAllowed&lt;/param-name&gt;
        &lt;param-value&gt;false&lt;/param-value&gt;
    &lt;/context-param&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Restricted folders&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/jettylivewar/*&lt;/url-pattern&gt;
            &lt;url-pattern&gt;/META-INF/*&lt;/url-pattern&gt;
            &lt;url-pattern&gt;/WEB-INF/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint /&gt;
    &lt;/security-constraint&gt;

&lt;/web-app&gt;</code></pre>
<p><a name="index_entry_index_3"></a>
Also directory listing was disabled using the parameter <code>dirAllowed</code>.</p>
<p>There's also an alternative solution by setting equivalent restrictions programmatically &mdash; 
see the method <code>applyRestrictions()</code> in the <code>ServerMain</code> class. This solution is preserved in
the code for information purpose but it cannot be used in this project because the live WAR 
file may also be called as a regular WAR file. So the possible solutions may be:</p>
<ul>
<li>to set these restrictions in the Spring MVC configuration (not tried yet);</li>
<li>to use a traditional <code>web.xml</code> configuration (the accepted option).</li>
</ul>
<p>Also see this <a href="jetty_server_notes.html#default_protected_targets">related topic</a>.</p>
<hr />
<p><a name="index_entry_index_4"></a></p>
<h1 id="warless-jar-with-jsp-incomplete">WARless JAR with JSP (incomplete)</h1>
<p>The following attempt was done to create an executable JAR with embedded Jetty server and JSP
support. This result was achieved but only when the project is run in the IntelliJ Idea IDE.
When run inside a package it doesn't work.</p>
<blockquote>
<p>Git commit: <a href="../patches/3944bb1851bdffd9f40e525e4f8abd573bc7c66c.html"><code>3944bb1851bdffd9f40e525e4f8abd573bc7c66c</code></a>
Embedded Jetty WARless packaging implemented (incomplete)</p>
</blockquote>
<p>Navigate to <localhost:8080> to see the result.</p>
<p>The main difference between the IDE and self contained versions is probably in the following
setting (class <a href="../../../projects/jetty-embedded-warless/src/main/java/jettywarless/Main.java"><code>Main</code></a>):</p>
<pre class="highlight"><code class="language-code">...
webAppContext.setExtraClasspath(appClasspath);
...</code></pre>
<p>Inside the IDE the value is like <code>file:/X:/path/to/jetty-embedded-warless/classes/</code>, but when 
running as the executable JAR it's like 
<code>file:/X:/path/to/jetty-embedded-warless/jetty-embedded-warless-1.0-SNAPSHOT.jar</code>.</p>
<p>So in the latter case much more classes fall into the initialization scope. The problem may 
probably be solved by restricting the web application context class path, but a method for this
was not found yet.</p>
<p>The <a href="https://stackoverflow.com/a/48932175/3868454">answer</a> to the StackOverflow question 
<a href="https://stackoverflow.com/questions/48928954/jetty-embedded-jsp-issues">jetty embedded jsp issues</a>
may be notable for understanding the perspectives:</p>
<blockquote>
<p>You have to setup JSP for Jetty, the mere existence of the JARs is insufficient.</p>
<p>...</p>
<p>Finally, some things you need to consider with JSP/JSTL/EL support:</p>
<ul>
<li>Don't bundle up in OSGi (the JSTL/EL/Standard libraries do not support this usage. mainly
  due to classloader expectations)</li>
<li>Don't use Java 9+ JPMS modules (the JSTL/EL/Standard libraries do not support this usage,
  mainly due to classloader expectations, and resource url expecations)</li>
<li>Don't create an uber jar (the JSTL/EL/Standard libraries do not support this)</li>
<li>Don't repackage the JSTL jars in any way, they need to stay as the JSTL/EL/Standard jars,
  available on the filesystem.</li>
<li>Don't create custom classloaders. (The JSTL/EL/Standard libraries expect a very narrow
  definition of a Classloader)</li>
</ul>
</blockquote>
<p><strong>Conclusions</strong></p>
<ul>
<li>This method may be used if JSP is not required, like servlets with <code>@ResponseBody</code> or REST.</li>
<li>JSP is a hard technology to be set up and adjusted (at least with Jetty), and it must be avoided
    wherever and whenever it's possible.</li>
</ul>
<p>&nbsp;</p>
<hr />

<p style="margin-top:0px;margin-bottom:0px;text-align:right;"><a href="jetty_server_notes.html" 
title="Previous: Jetty server notes"><img src="../../layout/pict/previous_page.png"/></a>


<img src="../../layout/pict/next_page_inactive.png"/></p>

<div style="height: 1000px;"><p>&nbsp;</p></div>




</body>
</html>

<!DOCTYPE html>
<html>
<head><title>Sessions and cookies</title>
<meta charset="utf-8">
<link rel="shortcut icon" type="image/png" href="../../favicon.png"/>
<link rel="stylesheet" type="text/css" href="../../layout/styles.css"/>
<link rel="stylesheet" type="text/css" href="../../layout/layout.css"/>
<link rel="stylesheet" type="text/css" href="../../theme.css"/>

<style>
.headerNavArrows {position: relative; top: 3px;}
</style>
</head>
<body>

<div class="header"><b><span style="color:greenyellow;margin-right:7px;">Spring Web</span></b><a 
class="header_item" href="../../../readme.html">About</a><a 
class="header_item" href="../index_page.html">Index</a>

<a href="../../../doc_src/content/intermediate/sessions_and_cookies.txt " class="header_item_source" title="Source text">&lt;/&gt;</a>


<a href="send_email.html" title="Previous: Send email"><img class="headerNavArrows" src="../../layout/pict/previous_page_h18px.png"/></a>


<img class="headerNavArrows" src="../../layout/pict/next_page_h18px_inactive.png"/>

<span class="headerTitle">Sessions and cookies</span>

</div>

<div class="sidebar">
    <table class="sidebarAligner">
        <tr><td valign="top">
            <div class="sidebar_item"><a href="../../../readme.html">About the course</a></div>
<div class="sidebar_item"><a href="../references.html">References</a></div>
<div class="sidebar_item"><a href="../common_notes.html">Common notes</a></div>
            <h3>Beginner</h3>
            <div class="sidebar_item"><a href="../beginner/about_part_1.html">About this part</a></div>
<div class="sidebar_item"><a href="../beginner/server_setup.html">Server setup</a></div>
<div class="sidebar_item"><a href="../beginner/front_controller.html">Front controller</a></div>
<div class="sidebar_item"><a href="../beginner/spring_web_app_setup.html">Spring web application setup</a></div>
<div class="sidebar_item"><a href="../beginner/web_application_context.html">Web application context</a></div>
<div class="sidebar_item"><a href="../beginner/view_resolver.html">View resolver</a></div>
<div class="sidebar_item"><a href="../beginner/model.html">Model</a></div>
            <h3>Intermediate</h3>
            <div class="sidebar_item"><a href="about_part_2.html">About this part</a></div>
<div class="sidebar_item"><a href="get_rid_of_web_xml.html">Get rid of XML configuration</a></div>
<div class="sidebar_item"><a href="data_binding.html">Data binding</a></div>
<div class="sidebar_item"><a href="registration_form.html">Registration form</a></div>
<div class="sidebar_item"><a href="form_validation.html">Form validation</a></div>
<div class="sidebar_item"><a href="formatters.html">Spring MVC Formatter</a></div>
<div class="sidebar_item"><a href="send_email.html">Send email</a></div>
<div class="sidebar_item selected"><a href="sessions_and_cookies.html">Sessions and cookies</a></div>
        </td></tr>
        <tr><td class="bottom" valign="bottom">
            Generated by <a href="https://github.com/arctrong/md2html">md2html_py</a> 1.0.2
        </td></tr>
    </table>
</div>

<p style="font-size:44px;font-weight:bold;margin:0 0 30px 0;">Sessions and cookies</p>

<div class="toc">
<ul>
<li><a href="#what-is-session-and-cookies">What is session and cookies</a></li>
<li><a href="#implement-cookies-transfer">Implement cookies transfer</a></li>
<li><a href="#managing-cookies-using-spring">Managing cookies using Spring</a></li>
<li><a href="#using-sessions">Using sessions</a></li>
<li><a href="#session-timeout">Session timeout</a></li>
<li><a href="#using-sessionattributes-annotation">Using @SessionAttributes annotation</a></li>
<li><a href="#conversational-scope">Conversational scope</a><ul>
<li><a href="#request-scope">Request scope</a></li>
</ul>
</li>
</ul>
</div>
<hr />
<p>Mar 30, 2023</p>
<p><a name="index_entry_index_1"></a></p>
<h1 id="what-is-session-and-cookies">What is session and cookies</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>]</p>
<p>HTTP is a stateless protocol so it doesn't save information between the requests. <strong>Cookies</strong>
were invented in maybe 1995 to fill this gap.</p>
<p>Also see [<a href="../references.html#ref_16">16</a>].</p>
<hr />
<h1 id="implement-cookies-transfer">Implement cookies transfer</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=743">12:23</a>]</p>
<p>This is the first simple implementation that is probably not to be used in production.</p>
<blockquote>
<p>Git commit: <a href="../patches/84ef7a5077be8aebf246e238b4f66d4efc2f220a.html"><code>84ef7a5077be8aebf246e238b4f66d4efc2f220a</code></a>
first simple cookie usage demonstrated</p>
</blockquote>
<p>In the <code>/validate-submit</code> endpoint we create a <code>Cookie</code> and add it to the <code>HttpServletResponse</code>
object that is provided by Spring MVC via the corresponding controller method parameter 
<code>response</code>. After the response is received the added cookie may be viewed in the debugger (F12):</p>
<p><img alt="" src="../../pict/debug_cookies.png" /></p>
<p>The added cookie is sent by the browser with every subsequent request so it can be used on every
page like the one that is returned by the <code>/validate</code> endpoint.</p>
<hr />
<p><a name="index_entry_index_2"></a></p>
<h1 id="managing-cookies-using-spring">Managing cookies using Spring</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=2248">37:28</a>]</p>
<p>The above method is much inconvenient especially when used in a lot of controllers. The Spring 
<code>@CookieValue</code> annotation may help simplify this task (see the <a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/EmailController.java"><code>EmailController</code></a>
class):</p>
<pre class="highlight"><code class="language-code">    @RequestMapping("/sendEmail")
    public String sendEmail(@CookieValue("myApp.userName") String userName, Model model) {
        model.addAttribute("sendEmailDto", new SendEmailDto());
        model.addAttribute("userName", userName);
        return "send-email-page";
    }</code></pre>
<blockquote>
<p>Git commit: <a href="../patches/fe7f898864fc585ea03e2e6e195c46e9700cf9ac.html"><code>fe7f898864fc585ea03e2e6e195c46e9700cf9ac</code></a>
using @CookieValue annotation</p>
</blockquote>
<hr />
<p>Apr 1, 2023</p>
<p><a name="index_entry_index_3"></a></p>
<h1 id="using-sessions">Using sessions</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=2605">43:25</a>]</p>
<p>Cookies are stored inside the client's computer and the client may not allow to drop such kind
of litter inside their system.</p>
<p>Cooking processing may be costly as they are just text files. Complex structures may be have
very large size. Also cookies may have size limitation.</p>
<p><img src="../../pict/session_cookie_sequence.png" class="floatRight" /></p>

<p>To address these problems there is an alternative called <strong>sessions</strong>.</p>
<p>A client sends a request. The application doesn't send the whole set of data to the client
but instead saves the session state in the database and returns to the client a response with above
single session ID.</p>
<p>On a next request the session ID cookie is sent back to the application that retrieves the session
state by this session ID and returns to the client the customized response.</p>
<p style="clear: both;"></p>

<p>In the <a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/ValidatedController.java"><code>ValidatedController</code></a>
class using setting a session attribute:</p>
<pre class="highlight"><code class="language-code">    @RequestMapping("/validate-submit")
    public String showCalculatePageSpring(&lt;...&gt;,
                                          HttpSession session) {
        .  .  .
        session.setAttribute("userName", dto.getName1());
        return "result-page-spring";
    }</code></pre>
<p>Then this attribute may be used on the JSP page like <a href="../../../projects/web-app-spring-adv3/src/main/webapp/WEB-INF/view/process-email-page.jsp"><code>process-email-page.jsp</code></a>:</p>
<pre class="highlight"><code class="language-xml">.  .  .
&lt;h1&gt;Hi ${userName}!&lt;/h1&gt;
.  .  .</code></pre>
<p>Or the session attributes may be transformed and set into the model likes it's don in the
<a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/EmailController.java"><code>EmailController</code></a>
class:</p>
<pre class="highlight"><code class="language-code">    @RequestMapping("/process-email")
    public String processEmail(@ModelAttribute SendEmailDto sendEmailDto,
                               HttpSession session, Model model) {
        model.addAttribute("userName", "dear " + session.getAttribute("userName"));
        return "process-email-page";
    }</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>On a JSP page, when resolving a placeholder variable, first an attempt is done to find this
variable in the model and if not found then it's searched in the session.</p>
</div>
<p>As servers have still limited storage capacity and the number of requests and different sessions 
may be huge, it's not recommended to store unnecessary data in sessions.</p>
<blockquote>
<p>Git commit: <a href="../patches/41ac2ee44af044b776a036a7bd891d9cf4347cf5.html"><code>41ac2ee44af044b776a036a7bd891d9cf4347cf5</code></a>
session usage demonstrated</p>
</blockquote>
<hr />
<h1 id="session-timeout">Session timeout</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=4868">1:21:08</a>]</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>javax.servlet.http.HttpSession</code> is not a part of Spring.</p>
</div>
<p><a name="index_entry_index_4"></a>
It may be unreasonable or even impossible to hold used session data forever. To limit the storage
period of time (in minutes) the following parameter may be used in the <code>web.xml</code> file:</p>
<pre class="highlight"><code class="language-xml">&lt;session-config&gt; 
    &lt;session-timeout&gt;20&lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre>
<p>In the code-based configuration (e.g. in the <a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/ValidatedController.java"><code>ValidatedController</code></a>
class) the <code>javax.servlet.http.HttpSession</code> object may be used for that
(in seconds):</p>
<pre class="highlight"><code class="language-code">    @RequestMapping("/validate-submit")
    public String showCalculatePageSpring(@Valid @ModelAttribute("dto") UserInfoValidatedDto dto, 
                                          HttpSession session) {

        session.setAttribute("userName", dto.getName1());
        session.setMaxInactiveInterval(20);

        return "result-page-spring";
    }</code></pre>
<p>It's proved that after 20 seconds of inactivity the session attribute <code>userName</code> is no longer
available. We are now not going to preserve this code in the project.</p>
<hr />
<p><a name="index_entry_index_5"></a></p>
<h1 id="using-sessionattributes-annotation">Using <code>@SessionAttributes</code> annotation</h1>
<p>[<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=5219">1:26:59</a>]</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using the following approach may be pretty tricky and may take much time for investigation of
possible errors. See <a href="sessions_and_cookies.html#conversational_scope">here</a> for more
extensive explanation.</p>
</div>
<p>The <code>@org.springframework.web.bind.annotation.SessionAttributes</code> annotation is added to the 
<a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/ValidatedController.java"><code>ValidatedController</code></a>
class:</p>
<pre class="highlight"><code class="language-code">@Controller
@SessionAttributes("userInfoDto")
public class ValidatedController {

    @RequestMapping("/validate")
    public String showHomePageSpring(Model model) {
        model.addAttribute("userInfoDto", new UserInfoValidatedDto());
        return "home-page-validated";
    }
    .  .  .</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Multiple model attributes may be specified in the <code>@SessionAttributes</code> annotation. 
Also see [<a href="../references.html#ref_2_13">2.13</a>, <a href="https://youtu.be/cpFfzE9eGT0?t=5979">1:39:39</a>].</p>
</div>
<p>In the <a href="../../../projects/web-app-spring-adv3/src/main/java/springmvcstudy2/controllers/EmailController.java"><code>EmailController</code></a>
we just remove the explicit session handling code.</p>
<p>In the views:</p>
<ul>
<li><a href="../../../projects/web-app-spring-adv3/src/main/webapp/WEB-INF/view/send-email-page.jsp"><code>send-email-page.jsp</code></a> and</li>
<li><a href="../../../projects/web-app-spring-adv3/src/main/webapp/WEB-INF/view/process-email-page.jsp"><code>process-email-page.jsp</code></a></li>
</ul>
<p>We just use the specified session attribute like this:</p>
<pre class="highlight"><code class="language-xml">.  .  .
&lt;h1&gt;Hi ${userInfoDto.name1}!&lt;/h1&gt;
.  .  .</code></pre>
<blockquote>
<p>Git commit: <a href="../patches/82d604c452010585bc401a28bb02907f8c378314.html"><code>82d604c452010585bc401a28bb02907f8c378314</code></a>
@SessionAttributes annotation used</p>
</blockquote>
<hr />
<p>Apr 3, 2023</p>
<p><a name="index_entry_index_6"></a><a name="conversational_scope"></a></p>
<h1 id="conversational-scope">Conversational scope</h1>
<p>new simple project created to make the description more clear. The URL is 
<a href="http://localhost:8080/web-app-spring-sessions/ui/first">http://localhost:8080/web-app-spring-sessions/ui/first</a>.</p>
<p>[<a href="../references.html#ref_2_14">2.14</a>, <a href="https://youtu.be/ezty6XhOpF8?t=40">0:40</a>]</p>
<blockquote>
<p>Git commit: <a href="../patches/92ef2e0ce13ce794115d2d47695b80ec1b2d8ea4.html"><code>92ef2e0ce13ce794115d2d47695b80ec1b2d8ea4</code></a>
new project created for sessions investigation</p>
</blockquote>
<p><a name="index_entry_index_7"></a></p>
<h2 id="request-scope">Request scope</h2>
<p>[<a href="../references.html#ref_2_14">2.14</a>, <a href="https://youtu.be/ezty6XhOpF8?t=247">4:07</a>]</p>
<p>This narration is going to be done for further comparison with the upper level scope.</p>
<p>Request scope defines data that is valid during a single request handling process, e.g. from the
request receipt to the response result sending. As the request is processed (like the rendered view
is sent to the client) the request scope is destroyed.</p>
<p>Two controller methods are defined:</p>
<pre class="highlight"><code class="language-code">    @RequestMapping("/first")
    public String firstHandler(Model model) {
        model.addAttribute("firstName", "Jan");
        model.addAttribute("lastName", "Hus");
        return "index";
    }

    @RequestMapping("/second")
    public String secondHandler(Model model) {
        String firstName = (String) model.getAttribute("firstName");
        System.out.println("firstName=" + firstName);
        return "index";
    }</code></pre>
<p>The first one sets two model attributes and the second one tries to asses it. The <code>Model</code> object
here has the request scope so the instances are different for the two requests and so in the
second method the requested attribute is absent:</p>
<pre class="highlight"><code class="language-shell">firstName=null</code></pre>
<p>The page is going to look like this:</p>
<p><img alt="" src="../../pict/request_scope.png" /></p>
<p>The first URL is <a href="http://localhost:8080/web-app-spring-sessions/ui/first">http://localhost:8080/web-app-spring-sessions/ui/first</a>.</p>
<blockquote>
<p>Git commit: <a href="../patches/705e5a346357e303c5b7dec577c7e82bcf1592a5.html"><code>705e5a346357e303c5b7dec577c7e82bcf1592a5</code></a>
request scope demonstrated</p>
</blockquote>
<p>[<a href="../references.html#ref_2_14">2.14</a>, <a href="https://youtu.be/ezty6XhOpF8?t=977">16:17</a>]</p>
<p>&nbsp;</p>
<hr />

<p style="margin-top:0px;margin-bottom:0px;text-align:right;"><a href="send_email.html" 
title="Previous: Send email"><img src="../../layout/pict/previous_page.png"/></a>


<img src="../../layout/pict/next_page_inactive.png"/></p>

<div style="height: 1000px;"><p>&nbsp;</p></div>

</body>
</html>
